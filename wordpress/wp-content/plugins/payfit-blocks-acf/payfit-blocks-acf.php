<?php

/**
 * Plugin Name:       Payfit blocks acf
 * Requires at least: 6.1
 * Requires PHP:      7.0
 * Version:           0.1.0
 * Author:            LMS
 * License:           GPL-2.0-or-later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       payfit-blocks-acf
 *
 * @package CreateBlock
 */

if (!defined('ABSPATH')) {
	exit; // Exit if accessed directly.
}

include_once(plugin_dir_path(__FILE__) . 'assets/global_fields/buttons.php');
include_once(plugin_dir_path(__FILE__) . 'assets/wysiwyg/toolbars.php');
include_once(plugin_dir_path(__FILE__) . 'assets/wysiwyg/colors_palette.php');
include_once(plugin_dir_path(__FILE__) . 'assets/wysiwyg/remove_html_tags.php');
include_once(plugin_dir_path(__FILE__) . 'assets/add_id_block.php');

// Import the ACF block
include_once(plugin_dir_path(__FILE__) . 'blocks/hero/acf.php');
include_once(plugin_dir_path(__FILE__) . 'blocks/image_tabs/acf.php');
include_once(plugin_dir_path(__FILE__) . 'blocks/logo_list/acf.php');
include_once(plugin_dir_path(__FILE__) . 'blocks/value_proposition/acf.php');
include_once(plugin_dir_path(__FILE__) . 'blocks/content/acf.php');
include_once(plugin_dir_path(__FILE__) . 'blocks/testimonial/acf.php');


/**
 * We use WordPress's init hook to make sure
 * our blocks are registered early in the loading
 * process.
 *
 * @link https://developer.wordpress.org/reference/hooks/init/
 */


function tt3child_register_acf_blocks()
{
	/**
	 * We register our block's with WordPress's handy
	 * register_block_type();
	 *
	 * @link https://developer.wordpress.org/reference/functions/register_block_type/
	 */
	register_block_type(__DIR__ . '/blocks/hero', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));
	register_block_type(__DIR__ . '/blocks/value_proposition', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));
	register_block_type(__DIR__ . '/blocks/image_tabs', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));
	register_block_type(__DIR__ . '/blocks/logo_list', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));
	register_block_type(__DIR__ . '/blocks/content', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));
	register_block_type(__DIR__ . '/blocks/testimonial', array(
		'supports'        => array(
			'align'        => false,
		),
		'icon'            => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
</svg>',

	));

	remove_filter('acf_the_content', 'wpautop');
}
// Here we call our tt3child_register_acf_block() function on init.
add_action('init', 'tt3child_register_acf_blocks');


function payfit_blocks_acf_enqueue_style()
{
	wp_register_style('payfit-blocks-acf', plugin_dir_url(__FILE__) . 'build/styles.css');
	wp_enqueue_style('payfit-blocks-acf');
}
add_action('wp_enqueue_scripts', 'payfit_blocks_acf_enqueue_style');
add_action('admin_enqueue_scripts', 'payfit_blocks_acf_enqueue_style');



function my_custom_block_category($block_categories, $editor_context)
{
	// Vérifiez si vous êtes dans l'éditeur des blocs
	if (!empty($editor_context->post)) {
		// Ajoutez une nouvelle catégorie
		$block_categories[] = array(
			'slug'  => 'payfit',
			'title' => __('Payfit', 'payfit-blocks-acf'),
			'icon'  => '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 37 36">
			<path clip-rule="evenodd" d="M18.0609 36C8.08616 36 0 27.9411 0 18C0 8.05887 8.08616 0 18.0609 0C28.0357 0 36.1219 8.05887 36.1219 18C36.1219 27.9411 28.0357 36 18.0609 36ZM17.8146 24.4023V20.8227C17.811 20.7674 17.8314 20.7133 17.8707 20.6741C17.91 20.6349 17.9644 20.6145 18.0199 20.6182H22.2273C25.1935 20.4988 27.5348 18.0647 27.5293 15.1061C27.5238 12.1475 25.1734 9.72203 22.2067 9.61364H11.9038C11.6771 9.61364 11.4933 9.79679 11.4933 10.0227V24.4636C11.4933 26.2033 12.9084 27.6136 14.654 27.6136C16.3996 27.6136 17.8146 26.2033 17.8146 24.4636C17.842 24.4227 17.842 24.4023 17.8146 24.4023ZM18.0199 15.9136H22.0015C22.4549 15.9136 22.8225 15.5473 22.8225 15.0955C22.8225 14.6436 22.4549 14.2773 22.0015 14.2773H16.6037C16.377 14.2773 16.1933 14.4604 16.1933 14.6864V24.4432C16.1933 25.2904 15.5041 25.9773 14.654 25.9773C13.8039 25.9773 13.1147 25.2904 13.1147 24.4432V11.4341C13.111 11.3788 13.1315 11.3246 13.1708 11.2854C13.2101 11.2463 13.2645 11.2259 13.3199 11.2295H22.0015C23.3947 11.204 24.6957 11.9211 25.4145 13.1107C26.1333 14.3004 26.1607 15.7819 25.4863 16.9971C24.812 18.2123 23.5383 18.9767 22.1452 19.0023H18.0199C17.9644 19.0059 17.91 18.9856 17.8707 18.9464C17.8314 18.9072 17.811 18.853 17.8146 18.7977V16.1386C17.8142 16.0219 17.9033 15.9242 18.0199 15.9136Z" fill="#0F6FDE" fill-rule="evenodd"/>
			</svg>', // Vous pouvez définir une icône ici
		);
	}
	return $block_categories;
}
add_filter('block_categories_all', 'my_custom_block_category', 10, 2);

function restrict_blocks_to_paragraph_and_payfit( $allowed_blocks, $editor_context ) {
    // Vérifiez si le contexte est une page
    if ( ! empty( $editor_context->post ) && $editor_context->post->post_type === 'page' ) {
        // Autoriser le bloc de paragraphe
        $allowed_blocks = array( 'core/paragraph' );

        // Récupérer tous les blocs enregistrés
        $registered_blocks = WP_Block_Type_Registry::get_instance()->get_all_registered();

        // Ajouter les blocs qui commencent par 'payfit/'
        foreach ( $registered_blocks as $block_name => $block_type ) {
            if ( strpos( $block_name, 'payfit/' ) === 0 ) {
                $allowed_blocks[] = $block_name;
            }
        }

        return $allowed_blocks;
    }

    // Retourner la liste des blocs autorisés par défaut pour les autres types de posts
    return $allowed_blocks;
}
add_filter( 'allowed_block_types_all', 'restrict_blocks_to_paragraph_and_payfit', 10, 2 );
